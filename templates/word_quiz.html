<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>è‹±å˜èªã‚¯ã‚¤ã‚º</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?ver=34">
  <style>
    body { font-family:"Hiragino Sans","Noto Sans JP",sans-serif; background: linear-gradient(135deg,#f8fafc,#eef2ff); margin:0; padding:0; color:#333; }
    .container { max-width:650px; margin:50px auto; text-align:center; background:white; border-radius:20px; box-shadow:0 10px 25px rgba(0,0,0,0.1); padding:30px 20px; }
    .main-title { font-size:2rem; margin-bottom:15px; background:linear-gradient(90deg,#4f46e5,#7c3aed); -webkit-background-clip:text; -webkit-text-fill-color:transparent; font-weight:700; }
    .average-score { margin-bottom:10px; font-weight:bold; color:#444; }
    .review-mode { font-size:0.95rem; color:#dc2626; margin-bottom:15px; font-weight:bold; }
    .quiz-card { padding:25px 20px; border-radius:16px; margin:25px auto; background:#f9fafb; box-shadow:0 5px 15px rgba(0,0,0,0.05); }
    .highlight { color:#111; font-weight:bold; }
    input, button { margin:10px; padding:10px 14px; font-size:1rem; border-radius:8px; }
    input { border:1px solid #ccc; width:60%; text-align:center; }
    .primary-btn { background:#2563eb; color:white; border:none; cursor:pointer; transition:0.2s; }
    .primary-btn:hover { background:#1d4ed8; }
    .secondary-btn { background:#6b7280; color:white; border:none; cursor:pointer; transition:0.2s; }
    .secondary-btn:hover { background:#4b5563; }
    .tts-btn { margin-left:6px; cursor:pointer; background:#e35f3e; border:none; border-radius:6px; padding:4px 8px; font-size:0.9rem; color:white; }
    #progress-container { margin-top:10px; text-align:center; display:none; }
    #progress-bar { height:8px; width:0%; background:linear-gradient(90deg,#4f46e5,#22c55e); border-radius:10px; transition:width 0.3s ease; }
    #progress-text { font-size:0.9rem; color:#555; margin-top:5px; }
    .card { border-radius:10px; padding:12px; margin:10px 0; color:#333; box-shadow:0 2px 6px rgba(0,0,0,0.05); text-align:left; }
    .accent-blue { border-left:5px solid #3b82f6; background:#eff6ff; }
    .accent-green { border-left:5px solid #10b981; background:#ecfdf5; }
    .label-advice { font-weight:bold; font-size:1.1rem; color:#7c3aed; margin-top:20px; }
    .label-score { font-weight:bold; color:#4f46e5; font-size:1.2rem; }
    .score-text { font-size:2.2rem; font-weight:800; color:#16a34a; margin:10px 0; transition:transform 0.3s ease; }
    .score-animate { animation:pop 0.6s ease; }
    @keyframes pop { 0%{transform:scale(0.3);} 50%{transform:scale(1.2);} 100%{transform:scale(1);} }
    .nav-links { margin-top:30px; }
    .nav-links a { margin:0 10px; text-decoration:none; color:#2563eb; font-weight:600; }
    .nav-links a.logout { color:#dc2626; }
    @media(max-width:480px){ .main-title { font-size:1.6rem; } .quiz-card { padding:20px 15px; } input, button { padding:8px 12px; font-size:0.95rem; } }
  </style>
</head>
<body>
<main class="container">
  <h1 class="main-title">è‹±å˜èªã‚¯ã‚¤ã‚º</h1>
  <p class="average-score">ğŸ’¯ å¹³å‡ã‚¹ã‚³ã‚¢: <span id="average-score">{{ average_score or 0 }}</span></p>
  {% if review %}<p class="review-mode">ğŸ’¡ è‹¦æ‰‹å˜èªå¾©ç¿’ãƒ¢ãƒ¼ãƒ‰ä¸­</p>{% endif %}
  <section class="quiz-card" id="quiz-card">
    <p class="word" id="word">â˜… å•é¡Œ: <span class="highlight">{{ word or 'ï¼ˆå˜èªãŒã‚ã‚Šã¾ã›ã‚“ï¼‰' }}</span>
      <button class="tts-btn" id="tts-word-btn">ğŸµ ç™ºéŸ³</button>
    </p>
    <input type="text" id="answer" placeholder="æ„å‘³ã‚’å…¥åŠ›" required>
    <button id="submit-btn" class="primary-btn">å›ç­”ã™ã‚‹</button>
    <div id="progress-container">
      <div id="progress-bar"></div>
      <p id="progress-text">0%</p>
    </div>
    <input type="hidden" id="word-id" value="{{ word_id or 0 }}">
  </section>
  <section class="feedback-box" id="feedback-box" style="display:none;">
    <div class="score-box">
      <p class="label-score">ã‚ãªãŸã®ã‚¹ã‚³ã‚¢:</p>
      <p class="score-text" id="score-text"></p>
    <!-- âœ… è‡ªåˆ†ã®å›ç­”ã¨æ­£è§£ã®è¡¨ç¤ºã‚«ãƒ¼ãƒ‰ -->
    <div id="user-vs-correct" style="margin:20px 0; display:none;">
      <div class="card accent-green">
        <strong>ã‚ãªãŸã®å›ç­”:</strong>
        <div id="user-answer" style="font-size:1.1rem; margin-top:5px;"></div>
      </div>
      <div class="card accent-blue">
        <strong>æ­£è§£ã®æ„å‘³:</strong>
        <div id="correct-answer" style="font-size:1.1rem; margin-top:5px;"></div>
      </div>
    </div>
    <!-- âœ… ã“ã“ã¾ã§è¿½åŠ  -->
    <div class="pos-meaning-box" id="pos-meaning-box"></div>
    <div class="example-box" id="example-box" style="display:none;">
      <p class="label-advice">ğŸ“– ä¾‹æ–‡:</p>
      <!-- æ–‡ã”ã¨ã«æ”¹è¡Œ -->
      <p id="example-sentence"></p>
      <p id="example-translation" style="color:#555; margin-top:4px;"></p>
      <button class="tts-btn" id="tts-example-btn">ğŸµ è‹±èªã‚’å†ç”Ÿ</button>
    </div>
    <div class="advice-box">
      <p class="label-advice">ğŸ§­ ã‚¢ãƒ‰ãƒã‚¤ã‚¹:</p>
      <p class="advice-text" id="feedback-text"></p>
    </div>
    <div id="next-buttons" style="margin-top:15px;"></div>
  </section>
  <nav class="nav-links">
    <a href="{{ url_for('index') }}">ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</a>
    {% if current_user and current_user.is_authenticated %}
      <a href="{{ url_for('logout') }}" class="logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
    {% endif %}
  </nav>
</main>

<script>
document.addEventListener("DOMContentLoaded", ()=>{
  const submitBtn = document.getElementById('submit-btn');
  const answerInput = document.getElementById('answer');
  const wordId = document.getElementById('word-id').value;
  const progressContainer = document.getElementById('progress-container');
  const progressBar = document.getElementById('progress-bar');
  const progressText = document.getElementById('progress-text');

  let voices=[];
  function loadVoices(){ voices = speechSynthesis.getVoices(); }
  speechSynthesis.onvoiceschanged = loadVoices;
  loadVoices();
  function playEnglishTTS(text){
    if(!text) return;
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang='en-US'; utter.rate=0.95; utter.pitch=1.0;
    const enVoice = voices.find(v=>v.lang.startsWith('en')&&v.name.includes('Google'))||voices.find(v=>v.lang.startsWith('en'));
    if(enVoice) utter.voice=enVoice;
    speechSynthesis.speak(utter);
  }

  document.getElementById('tts-word-btn')?.addEventListener('click', ()=>playEnglishTTS(document.querySelector('#word .highlight')?.textContent));
  document.getElementById('tts-example-btn')?.addEventListener('click', ()=>playEnglishTTS(document.getElementById('example-sentence')?.textContent));

  submitBtn.addEventListener('click', async ()=>{
    const answer=answerInput.value.trim();
    if(!answer) return alert('å›ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');

    submitBtn.disabled=true; submitBtn.textContent='æ¡ç‚¹ä¸­...';
    progressContainer.style.display='block';
    let progress=0;
    const interval=setInterval(()=>{
      progress=Math.min(progress+Math.random()*15,90);
      progressBar.style.width=progress+'%';
      progressText.textContent=Math.floor(progress)+'%';
    },300);

    try{
      const reviewFlag="{{ 1 if review else 0 }}";
      const response=await fetch("{{ url_for('api_submit_answer') }}",{
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body:`word_id=${encodeURIComponent(wordId)}&answer=${encodeURIComponent(answer)}&review=${encodeURIComponent(reviewFlag)}`
      });
      if(!response.ok) throw new Error('ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼');
      const data=await response.json();

      clearInterval(interval);
      progressBar.style.width='100%';
      progressText.textContent='100%';

      setTimeout(()=>{
        progressContainer.style.display='none';
        document.getElementById('quiz-card').style.display='none';
        const feedbackBox=document.getElementById('feedback-box');
        feedbackBox.style.display='block';

        const nextButtons=document.getElementById('next-buttons');
        nextButtons.innerHTML='';

        const nextNormal=document.createElement('button');
        nextNormal.textContent='é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§æ¬¡ã¸ â–¶';
        nextNormal.className='secondary-btn';
        nextNormal.onclick=()=>location.href='{{ url_for("word_quiz") }}';
        nextButtons.appendChild(nextNormal);

        {% if current_user and current_user.is_authenticated %}
        const nextReview=document.createElement('button');
        nextReview.textContent='è‹¦æ‰‹ãƒ¢ãƒ¼ãƒ‰ã§æ¬¡ã¸ â–¶';
        nextReview.className='primary-btn';
        nextReview.style.marginLeft='10px';
        nextReview.onclick=()=>location.href='{{ url_for("word_quiz", review=1) }}';
        nextButtons.appendChild(nextReview);
        {% endif %}
      },400);

      document.getElementById('average-score').textContent=data.average_score ?? 0;

      const posMeaningBox=document.getElementById('pos-meaning-box');
      posMeaningBox.innerHTML='';
      if(data.pos) posMeaningBox.innerHTML+=`<div class="card accent-blue"><div>ğŸ“˜ å“è©</div><div>${data.pos}</div></div>`;
      if(data.simple_meaning) posMeaningBox.innerHTML+=`<div class="card accent-green"><div>ğŸ’¡ æ„å‘³</div><div>${data.simple_meaning}</div></div>`;

      if(data.score!==undefined){
        const scoreEl=document.getElementById('score-text');
        scoreEl.textContent=`${data.score} ç‚¹`;
        scoreEl.classList.add('score-animate');
      }

      document.getElementById('feedback-text').innerHTML=(data.feedback||'').replace(/\n/g,'<br>');

      if(data.example){
        const exampleBox=document.getElementById('example-box');
        exampleBox.style.display='block';
        // ------------------------------
        // æ–‡ã”ã¨ã«æ”¹è¡Œã—ã¦è¡¨ç¤ºã™ã‚‹å‡¦ç†ï¼ˆæ”¹è‰¯ç‰ˆï¼‰
        const sentences = data.example.split(/(?<=[ã€‚.!?])\s+/); // å¥ç‚¹ã‚„ãƒ”ãƒªã‚ªãƒ‰ã®å¾Œã®ç©ºç™½ã§åˆ†å‰²
        document.getElementById('example-sentence').innerHTML = sentences.map(s => s.trim()).filter(Boolean).join('<br>');
        document.getElementById('example-translation').textContent = data.example_ja || '';

      }

    }catch(err){
      clearInterval(interval);
      alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼: '+err.message);
      progressContainer.style.display='none';
    }finally{
      submitBtn.disabled=false;
      submitBtn.textContent='å›ç­”ã™ã‚‹';
    }
  });
});
</script>
</body>
</html>
