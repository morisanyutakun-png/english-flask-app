<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>æ—¥æœ¬èªè¨³æ¡ç‚¹çµæœ</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?ver=39">
  <style>
    body { font-family:"Hiragino Sans","Noto Sans JP",sans-serif; margin:0; padding:0; background: linear-gradient(135deg,#eef2ff,#f8fafc); color:#333; }
    .container { max-width:720px; margin:60px auto; padding:20px; display:flex; flex-direction:column; align-items:center; position:relative; }
    .logout-btn { position: fixed; top:20px; right:20px; background: linear-gradient(135deg,#dc2626,#b91c1c); color:white; border:none; border-radius:12px; padding:10px 16px; font-weight:600; cursor:pointer; box-shadow:0 4px 15px rgba(220,38,38,0.3); transition:0.3s; z-index:100; }
    .logout-btn:hover { transform: translateY(-2px); box-shadow:0 6px 20px rgba(220,38,38,0.4); }

    h1 { font-size:2.2rem; margin-bottom:40px; background: linear-gradient(90deg,#4f46e5,#7c3aed); -webkit-background-clip:text; -webkit-text-fill-color:transparent; font-weight:800; text-align:center; }

    .score-box { background:#ffffffdd; backdrop-filter:blur(8px); padding:20px 30px; border-radius:16px; margin-bottom:40px; width:100%; text-align:center; box-shadow:0 10px 25px rgba(0,0,0,0.1);}
    #score { font-size:3rem; font-weight:900; color:#16a34a; }

    .card { width:100%; background: linear-gradient(145deg,#ffffff,#f0f0ff); border-radius:18px; padding:24px; margin:20px 0; box-shadow:0 8px 20px rgba(0,0,0,0.1),0 4px 8px rgba(0,0,0,0.05); transition:transform 0.3s, box-shadow 0.3s; }
    .card:hover { transform: translateY(-6px); box-shadow:0 15px 30px rgba(0,0,0,0.15),0 6px 12px rgba(0,0,0,0.08); }
    .card h3 { font-size:1.2rem; margin-bottom:12px; color:#7c3aed; display:flex; align-items:center; justify-content:space-between; }
    .card p { font-size:1rem; line-height:1.6; color:#333; }

    .tts-btn { cursor:pointer; background:#ff5722; border:none; border-radius:8px; padding:5px 12px; font-size:0.9rem; color:white; font-weight:600; transition:0.2s; }
    .tts-btn:hover { background:#e64a19; }

    .btn-group { margin-top:30px; display:flex; gap:15px; flex-wrap:wrap; justify-content:center; }
    .btn { padding:12px 28px; border-radius:12px; border:none; font-weight:700; cursor:pointer; font-size:1rem; transition:0.3s; text-decoration:none; display:inline-block; }
    .btn-primary { background:linear-gradient(135deg,#4f46e5,#7c3aed); color:white; box-shadow:0 4px 15px rgba(79,70,229,0.3);}
    .btn-primary:hover { transform:translateY(-3px); box-shadow:0 6px 20px rgba(79,70,229,0.4);}
    .btn-secondary { background:linear-gradient(135deg,#6b7280,#4b5563); color:white; box-shadow:0 4px 15px rgba(107,114,128,0.3);}
    .btn-secondary:hover { transform:translateY(-3px); box-shadow:0 6px 20px rgba(107,114,128,0.4); }

    @media(max-width:480px){ #score{ font-size:2.4rem; } .card{ padding:20px; } .btn{ padding:10px 20px; font-size:0.95rem; } .logout-btn{ padding:8px 12px; font-size:0.9rem; } }
  </style>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2845219606700930"
     crossorigin="anonymous"></script>
</head>
<body>
  {% if not is_guest %}
  <button class="logout-btn" onclick="location.href='{{ url_for('logout') }}'">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  {% endif %}

  <div class="container">

    <!-- ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div style="width:100%; text-align:center; margin-bottom:20px;">
          {% for message in messages %}
            <p style="color:#16a34a; font-weight:600;">{{ message }}</p>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <h1>æ—¥æœ¬èªè¨³æ¡ç‚¹çµæœ</h1>

    <div class="score-box">
      <h2 id="score" data-score="{{ score|default(0) }}">0 ç‚¹</h2>
    </div>

    <!-- è‹±æ–‡ã‚«ãƒ¼ãƒ‰ -->
    <div class="card">
      <h3>ğŸ“– è‹±æ–‡
        <button class="tts-btn" id="tts-prompt-btn">ğŸµ è‹±æ–‡ã‚’å†ç”Ÿ</button>
      </h3>
      <p id="reading-prompt">{{ prompt|default('è‹±æ–‡ãŒã‚ã‚Šã¾ã›ã‚“') }}</p>
    </div>

    <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨³ã‚«ãƒ¼ãƒ‰ -->
    <div class="card">
      <h3>âœ ã‚ãªãŸã®æ—¥æœ¬èªè¨³</h3>
      <p>{{ answer|default('ï¼ˆå›ç­”ãªã—ï¼‰') }}</p>
    </div>

    <!-- æ¨¡ç¯„æ—¥æœ¬èªè¨³ã‚«ãƒ¼ãƒ‰ -->
    <div class="card">
      <h3>ğŸ“ æ¨¡ç¯„æ—¥æœ¬èªè¨³</h3>
      <p id="example-jp">{{ correct_example|default('') }}</p>
      <!-- éè¡¨ç¤ºã§è‹±æ–‡ä¿æŒ -->
      <p id="example-en" style="display:none;">{{ prompt|default('') }}</p>
    </div>

    <!-- ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚«ãƒ¼ãƒ‰ -->
    <div class="card">
      <h3>ğŸ§­ ã‚¢ãƒ‰ãƒã‚¤ã‚¹</h3>
      <p>{{ feedback|default('') }}</p>
    </div>

    {% if not is_guest and score < 50 %}
    <div class="card">
      <h3>ğŸ’¡ è‹¦æ‰‹ãƒ¢ãƒ¼ãƒ‰ç™»éŒ²</h3>
      <form method="POST" action="{{ url_for('add_to_weak') }}">
        <input type="hidden" name="user_id" value="{{ user_id|default(0) }}">
        <input type="hidden" name="prompt_id" value="{{ prompt_id|default(0) }}">
        <label>
          <input type="checkbox" name="add_to_weak" value="1" {% if added_to_weak %}checked{% endif %}>
          ã“ã®å•é¡Œã‚’è‹¦æ‰‹ãƒ¢ãƒ¼ãƒ‰ã«è¿½åŠ ã™ã‚‹
        </label>
        <br><br>
        <button type="submit" class="btn btn-secondary">ä¿å­˜</button>
      </form>
    </div>
    {% endif %}

    <div class="btn-group">
      <a href="{{ url_for('index') }}" class="btn btn-primary">ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</a>
      <a href="{{ url_for('reading_quiz') }}" class="btn btn-secondary">æ¬¡ã®å•é¡Œã¸</a>
    </div>
  </div>

  <script>
    // ===== ã‚¹ã‚³ã‚¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ =====
    window.onload = function() {
      const scoreEl = document.getElementById('score');
      const finalScore = parseInt(scoreEl.dataset.score) || 0;
      let current = 0;
      const interval = setInterval(() => {
        if(current < finalScore){ current++; scoreEl.textContent = current + ' ç‚¹'; }
        else clearInterval(interval);
      }, 20);
    };

    // ===== è‹±æ–‡TTS =====
    let voices=[];
    function loadVoices(){ voices=speechSynthesis.getVoices(); if(!voices.length)setTimeout(loadVoices,100);}
    speechSynthesis.onvoiceschanged = loadVoices;
    loadVoices();

    function playEnglishTTS(text){
      if(!text) return;
      if(!voices.length){ voices = speechSynthesis.getVoices(); setTimeout(()=>playEnglishTTS(text),100); return; }
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang='en-US';
      utter.rate=0.95;
      utter.pitch=1.0;
      utter.volume=1.0;
      const enVoice = voices.find(v=>v.lang.startsWith('en') && v.name.includes('Google')) || voices.find(v=>v.lang.startsWith('en'));
      if(enVoice) utter.voice = enVoice;
      speechSynthesis.speak(utter);
    }

    // è‹±æ–‡å†ç”Ÿãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById('tts-prompt-btn')?.addEventListener('click', () => {
      const text = document.getElementById('reading-prompt')?.textContent;
      playEnglishTTS(text);
    });

    // æ¨¡ç¯„æ—¥æœ¬èªè¨³ã‚«ãƒ¼ãƒ‰ã®éè¡¨ç¤ºè‹±æ–‡å†ç”Ÿã‚‚å¯èƒ½
    document.getElementById('tts-english-btn')?.addEventListener('click', () => {
      const text = document.getElementById('example-en')?.textContent;
      playEnglishTTS(text);
    });
  </script>
</body>
</html>
